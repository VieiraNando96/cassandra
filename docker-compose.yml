version: '3.8'

services:
  cassandra-seed:
    image: cassandra:latest
    container_name: cassandra-seed
    ports:
      - "9042:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=MyCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - CASSANDRA_SEEDS=cassandra-seed
      - MAX_HEAP_SIZE=1G
      - HEAP_NEWSIZE=200M
    volumes:
      - cassandra_seed_data:/var/lib/cassandra
    networks:
      - cassandra-network
    mem_limit: 2g
    mem_reservation: 1g
    cpus: 2.0
    healthcheck:
      test: ["CMD-SHELL", "cqlsh -e 'describe cluster'"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

  cassandra-node1:
    image: cassandra:latest
    container_name: cassandra-node1
    ports:
      - "9043:9042"
    environment:
      - CASSANDRA_CLUSTER_NAME=MyCluster
      - CASSANDRA_DC=dc1
      - CASSANDRA_RACK=rack1
      - CASSANDRA_ENDPOINT_SNITCH=GossipingPropertyFileSnitch
      - CASSANDRA_SEEDS=cassandra-seed
      - MAX_HEAP_SIZE=1G
      - HEAP_NEWSIZE=200M
    volumes:
      - cassandra_node1_data:/var/lib/cassandra
    networks:
      - cassandra-network
    mem_limit: 2g
    mem_reservation: 1g
    cpus: 2.0
    depends_on:
      - cassandra-seed
    restart: unless-stopped

  jupyter-pyspark:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: jupyter-pyspark-app
    ports:
      - "8888:8888"  # Jupyter
      - "4040:4040"  # Spark UI
    volumes:
      - ./notebooks:/home/jovyan/work  # Seus notebooks aqui
      - ./data:/home/jovyan/data       # Seus dados aqui
    networks:
      - cassandra-network
    depends_on:
      - cassandra-seed
    environment:
      - JUPYTER_ENABLE_LAB=yes
      - GRANT_SUDO=yes
      - SPARK_OPTS=--driver-java-options=-Xms2g --driver-java-options=-Xmx4g
    mem_limit: 4g
    mem_reservation: 2g
    cpus: 3.0
    shm_size: 2g
    restart: unless-stopped

volumes:
  cassandra_seed_data:
  cassandra_node1_data:

networks:
  cassandra-network:
    driver: bridge